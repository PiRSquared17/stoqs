<html xmlns="http://www.w3.org/1999/xhtml"> 
    <head> 
    <title>MBARI {{ dbAlias }} database</title> 
    <style type="text/css"> 
     #map { 
           width: 800px; 
           height: 800px; 
           border: 1px solid #eee;
          } 
    </style> 
    <script src="http://openlayers.org/dev/OpenLayers.js"></script> 
    <script src="http://maps.google.com/maps/api/js?v=3.2&sensor=false"></script>
    <script type="text/javascript">
      OpenLayers.IMAGE_RELOAD_ATTEMPTS = 4;
      OpenLayers.Util.onImageLoadError = function() {this.style.display="none"; };
      var map = null; 
      function init() {
            var options = {
                 projection: new OpenLayers.Projection("EPSG:900913"),
                 displayProjection: new OpenLayers.Projection("EPSG:4326"),
                 units: "m",
                 maxResolution: 156543.0339,
                 maxExtent: new OpenLayers.Bounds(-20037508.34, -20037508.34,
                                                   20037508.34, 20037508.34)
            };
            map = new OpenLayers.Map('map',options);
            var gphy = new OpenLayers.Layer.Google(
                "Google Physical",
                {'type': google.maps.MapTypeId.TERRAIN,
                 'sphericalMercator': true}
            );
            var gmap = new OpenLayers.Layer.Google(
                "Google Streets", // the default
                {'sphericalMercator': true,
                 numZoomLevels: 20}
            );
            var ghyb = new OpenLayers.Layer.Google(
                "Google Hybrid",
                {'type': google.maps.MapTypeId.HYBRID, 
                 numZoomLevels: 20,
                 'sphericalMercator': true}
            );
            var gsat = new OpenLayers.Layer.Google(
                "Google Satellite",
                {'type': google.maps.MapTypeId.SATELLITE, 
                 numZoomLevels: 22,
                 'sphericalMercator': true}
            );

            {% for item in list %}
            itemid_{{ item.id }} = new OpenLayers.Layer.WMS(
                    "{{ item.name }}",
                    "http://{{ mapserver_host }}/cgi-bin/mapserv",
                    { layers: '{{ item.name }}',
                      map: '{{ mappath }}',
                      transparent: 'True' },
                    { units: 'degrees',
                      //displayInLayerSwitcher: false,
                      projection: "EPSG:900913",
                      reproject: false,
                      visibility: false,
                      displayOutsideMaxExtent: true });
            map.addLayers([itemid_{{ item.id }}]); 
            {% endfor %}

            map.addLayers([gsat,gphy,ghyb]);
            update_date();
            map.setCenter(new OpenLayers.LonLat(-13594478.3, 4411945.3), 9);
            map.addControl(new OpenLayers.Control.LayerSwitcher({'div':OpenLayers.Util.getElement('activities-layerswitcher')}));
            map.addControl(new OpenLayers.Control.MousePosition());
            map.addControl(new OpenLayers.Control.PanZoomBar());
            {% for item in list %}
            map.events.register('click', map, function (e) {
                    OpenLayers.Util.getElement('nodeList').innerHTML = "Loading... please wait...";
                    var url =  itemid_{{ item.id }}.getFullRequestString({
                                    REQUEST: "GetFeatureInfo",
                                    EXCEPTIONS: "application/vnd.ogc.se_xml",
                                    BBOX: itemid_{{ item.id }}.map.getExtent().toBBOX(),
                                    X: e.xy.x,
                                    Y: e.xy.y,
                                    FEATURE_COUNT: 1000,
                                    INFO_FORMAT: 'text/html',
                                    QUERY_LAYERS: itemid_{{ item.id }}.params.LAYERS,
                                    WIDTH: itemid_{{ item.id }}.map.size.w,
                                    HEIGHT: itemid_{{ item.id }}.map.size.h});
                    OpenLayers.loadURL(url, '', this, setHTML);
                    OpenLayers.Event.stop(e);
            });
            {% endfor %}
            update_date();
      }
      function setHTML(response) {
            OpenLayers.Util.getElement('nodeList').innerHTML = response.responseText;
      }
      function update_date() {
            var string = OpenLayers.Util.getElement('year').value + "-" +
                       OpenLayers.Util.getElement('month').value + "-" +
                       OpenLayers.Util.getElement('day').value + "/" +
                       OpenLayers.Util.getElement('eyear').value + "-" +
                       OpenLayers.Util.getElement('emonth').value + "-" +
                       OpenLayers.Util.getElement('eday').value 

            {% for item in list %}
            itemid_{{ item.id }}.mergeNewParams({'time':string});
            {% endfor %}
      }
    </script> 
    </head> 
    <!-- Don't initialize the map until the body 
         has completed loading -->
    <body onload="init()"> 
        <input size="4" type='text' id='year' value="2010" onchange="update_date()"/>-<input size="2" type="text" id="month" value="08" onchange="update_date()"/>-<input size="2" type="text" id="day" value="29" onchange="update_date()" /> /
        <input size="4" type='text' id='eyear' value="2012" onchange="update_date()"/>-<input size="2" type="text" id="emonth" value="09" onchange="update_date()"/>-<input size="2" type="text" id="eday" value="29" onchange="update_date()" />

        <div id="map"></div> 
        <div> 
          <h1 style="font-size:1.3em;">Information</h1> 
          <p style="font-size:.8em;">Click a feature to see information about it below.</p> 
          <div id="nodeList"> 
        </div> 
        </div> 
        <div id="activities-layerswitcher"  class="olControlLayerSwitcher"></div>
    </body> 
    
</html> 

