<!DOCTYPE html> <!--  HTML5 Doctype -->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>STOQS {{request.META.dbAlias}} Database</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- The styles -->
    <link href="{{STATIC_URL}}bootstrap/css/bootstrap.css" rel="stylesheet">
    <style>
      body {
        padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
      }
      .stoqs-toggle {
        width: 100%;
      }
      th {
        align: center; /* Doesn't seem to work '*/
      }
    </style>
    <link href="{{STATIC_URL}}bootstrap/css/bootstrap-responsive.css" rel="stylesheet">
    <link type="text/css" href="{{ STATIC_URL }}jquery/css/custom-theme/jquery-ui-1.8.17.custom.css" rel="stylesheet" />    
    

    <!-- The HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- The fav and touch icons -->
    <link rel="shortcut icon" href="{{STATIC_URL}}media/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="{{STATIC_URL}}bootstrap/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="{{STATIC_URL}}bootstrap/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="{{STATIC_URL}}bootstrap/ico/apple-touch-icon-57-precomposed.png">
  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="#">STOQS {{request.META.dbAlias}} Database</a>
          <div class="nav-collapse">
            <ul class="nav">
              <li class="active"><a href="#">Home</a></li>
              <li><a href="http://www.mbari.org">MBARI</a></li>
              <li><a href="http://www.mbari.org/news/contact_us.html">Contact</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container-fluid">

      <div class="row-fluid">
         <div id="map" class="span6">
         </div><!-- span -->

                <div class="span6">
                    <div class="accordion well" id="accordion2">
                        <div class="accordian-group">
                            <div class="accordian-heading">
                                <h3><a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseOne">
                                Parameters
                                </a></h3>
                            </div>
                            <div id="collapseOne" class="accordion-body collapse in">
                                <div class="accordion-inner">
                                    <table id="parameter-table" class="table table-condensed table-bordered">
                                        <thead>
                                            <tr>
                                              <th width="10%">Display</th>
                                              <th width="10%">Select</th>
                                              <th>Parameter</th>
                                            </tr>
                                      </thead>
                                      <tbody>
                                      </tbody>
                                    </table>
                                </div>
                            </div>
                        </div><!-- accordian-group -->
                        <div class="accordian-group">
                            <div class="accordian-heading">
                                <h3><a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseTwo">
                                Platforms
                                </a></h3>
                            </div>
                            <div id="collapseTwo" class="accordion-body collapse in">
                                <div class="accordion-inner">
                                    <table id="platform-table" class="table table-condensed table-bordered">
                                        <thead>
                                            <tr>
                                              <th width="10%">Display</th>
                                              <th>Platform</th>
                                            </tr>
                                      </thead>
                                      <tbody>
                                      </tbody>
                                    </table>                                
                                </div>
                            </div>
                        </div><!-- accordian-group -->
                        <div class="accordian-group">
                            <div class="accordian-heading">
                                <h3><a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseThree">
                                Range Parameters
                                </a></h3>
                            </div>
                            <div id="collapseThree" class="accordion-body collapse in">
                                <div class="accordion-inner">
                                    <table id="range-table" class="table table-condensed">
                                    <tbody>
                                        <tr>
                                            <td colspan="2"><strong>Time Range</strong></td>
                                        </tr>
                                        <tr>
                                            <td colspan="2"><div id="slider-time"></div></td>
                                        </tr>
                                        <tr>
                                            <td><input class="span2 slider-values" type="text" id="start-time" "name="start-time"></td>
                                            <td><input class="span2 slider-values" type="text" id="end-time" name="end-time"></td> 
                                        </tr>
                                        
                                        <tr>
                                            <td colspan="2"><strong>Depth Range</strong></td>
                                        </tr>
                                        <tr>
                                            <td colspan="2"><div id="slider-depth"></div></td>
                                        </tr>
                                        <tr>
                                            <td><input class="span2 slider-values" type="text" id="start-depth" "name="start-depth"></td>
                                            <td><input class="span2 slider-values" type="text" id="end-depth" name="end-depth"></td> 
                                        </tr>
                                        
                                    </tbody>
                                    </table>
                                </div>
                            </div>
                        </div><!-- accordian-group -->   
                    </div><!-- accordian -->

                     </div><!-- span -->
      </div><!-- row-fluid -->
            <div class="row-fluid">
                <div class="span12 page-header">
                    
                        <div class="well">
                        <h3><strong id="result_count">0</strong> data points found.</h3>
                        <h4>Copy the links below to save them, click on the buttons to download in the specified format.</h4>
                        {% for format, description in formats.items %}
                        <div class="row-fluid">
                        <input id="{{format}}-field" type="text" class="span6" readonly="readonly">
                        <span class="help-inline span4"><a target="_blank" id="{{format}}-link" class="btn btn-info btn-small" href=""><i class="icon-file"></i> {{description}}</a></span>
                        {% endfor %}            
                        </div>          
                        </div><!-- well -->
                </div><!-- span -->
            </div><!-- row-fluid --> 

    </div> <!-- container -->

    <!-- The javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/javascript" src="{{ STATIC_URL }}jquery/js/jquery-1.7.1.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}jquery/js/jquery-ui-1.8.17.custom.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}jquery/js/jquery.dateFormat-1.0.js"></script>
    <script src="{{STATIC_URL}}bootstrap/js/bootstrap-transition.js"></script>
    <script src="{{STATIC_URL}}bootstrap/js/bootstrap-alert.js"></script>
    <script src="{{STATIC_URL}}bootstrap/js/bootstrap-modal.js"></script>
    <script src="{{STATIC_URL}}bootstrap/js/bootstrap-dropdown.js"></script>
    <script src="{{STATIC_URL}}bootstrap/js/bootstrap-scrollspy.js"></script>
    <script src="{{STATIC_URL}}bootstrap/js/bootstrap-tab.js"></script>
    <script src="{{STATIC_URL}}bootstrap/js/bootstrap-tooltip.js"></script>
    <script src="{{STATIC_URL}}bootstrap/js/bootstrap-popover.js"></script>
    <script src="{{STATIC_URL}}bootstrap/js/bootstrap-button.js"></script>
    <script src="{{STATIC_URL}}bootstrap/js/bootstrap-collapse.js"></script>
    <script src="{{STATIC_URL}}bootstrap/js/bootstrap-carousel.js"></script>
    <script src="{{STATIC_URL}}bootstrap/js/bootstrap-typeahead.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}OpenLayers-2.11/OpenLayers.js"></script> 
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?v=3.2&amp;sensor=false"></script>
    <script type="text/javascript">
    
    var stoqsQuery='{{site_uri}}{% url stoqs-query-summary dbAlias=request.META.dbAlias  %}';
    var params={}
    var request=''
    
    // Called with an element that was selectable, should make that element non-selectable.
    function disableButton(element) {
        if (! $(element).is('.disabled')) {
            $(element).removeClass('btn-primary'); // Unselect if it's selected.
            $(element).addClass('disabled'); // Add the disabled class to it.
        }
    }
    
    // Called with an element that was selectable, should make that element selectable.
    function enableButton(element) {
        if ($(element).is('.disabled')) {
            $(element).removeClass('disabled');
        }
    }
    
    // Set the URL fields and buttons to use the current queried URL
    function setUrls() {
        var base_url='{{site_uri}}{% url stoqs-query-ui dbAlias=request.META.dbAlias %}';
        var param=($.param($.map(params, function(v, k) { return ($.type(v) === "array") ? $.map(v, function(v) { return {name: k, value: v} }) : {name: k, value: v} })))
        if (param != '') {
            param = '?' + param;
        } 
        // Use the Django variable to populate the supported query formats.
        var formats=[{% for format, description in formats.items %}'{{format}}'{% if not forloop.last %},{% endif %}{%endfor%}]
        // Iterate over the formats and update the fields/buttonts to use the new URL's to get the data.
        $.each(formats, function (index, value) {
            var url=base_url + value + param;
            $('#'+value+'-field').val(url);
            $('#'+value+'-link').attr('href',url);
        });
    }
    
    function toggleField(element) {
        var $element=$(element);
        if (! $(element).is('.disabled')) { // If it's disabled, then don't bother toggling it.
            if ($element.is('.btn-primary')) {
                $element.removeClass('btn-primary');
            } else {
                $element.addClass('btn-primary');
            }
        }
    }
    
    function makeSlider(divid, type, data){
        if (type == 'time') {
            var start=new Date(data[0]);
            var end=new Date(data[1]);
            var max=Math.abs((start.getTime() - end.getTime()));
            var min=0
        } else if (type == 'depth') {
            // Float/Decimal type
            var min=Math.floor(data[0]*10000);
            var max=Math.ceil(data[1]*10000);
        }
        if (type == 'time') {
            var formatter=function (value) { 
                var start=new Date(data[0]);
                var cur=new Date(start.getTime() + value);
                return $.format.date(cur,'yyyy-MM-dd hh:mm:ss');
            };
            var reverseformatter=function (value) {
                var start=new Date(data[0]);
                try {
                    var end=new Date(value);
                } catch (err) {
                    var end=new Data(data[1]).getTime();
                }
                var cur=Math.abs((start.getTime() - end.getTime()));
                return cur;
            };
        } else if (type == 'depth') {
            // Float/Decimal type
            var formatter=function(value) { return value/10000; };
            var reverseformatter=function(value) { return value *10000; };
        }
        var options={max: max,
                     min: min,
                     values: [min, max],
                     range: true
        };
        
        var div=$('#' + divid);
        div.bind({
            slide : function (event, ui) { recordUpdatedValues(ui.values, divid, type, formatter, false); },
            slidechange:function (event, ui) { recordUpdatedValues(ui.values, divid, type, formatter, true); }
        })
        div.slider(options);
        
        div.data("reverseformatter", reverseformatter);
        if (typeof postaddfunc != "undefined") {
           //div.data("postaddfunction", postaddfunc);
        }
        return div;
    }
    
    function recordUpdatedValues(values, divid, type, formatter, updateTable) {
        var min=formatter(values[0])
        var max=formatter(values[1])
        $('#start-' + type).val(min)
        $('#end-' + type).val(max)
        if (updateTable) {
            rebuildFilters();
        }
    }
    
    function rebuildFilters() {
        params={}
        params['start_time']=$('#start-time').val()
        params['end_time']=$('#end-time').val()
        params['min_depth']=$('#start-depth').val()
        params['max_depth']=$('#end-depth').val()
        params['parameters']=[]
        params['platforms']=[]
        $('tr',$('#parameter-table')).each(function (index, element) {
            if ($('.btn-primary', $(element)).length) {
                params['parameters'].push(element.id);
            }
        });
        $('tr',$('#platform-table')).each(function (index, element) {
            if ($('.btn-primary', $(element)).length) {
                params['platforms'].push(element.id);
            }
        });
        updateSummaryData();
    }
    
    $(document).on('click', ".stoqs-toggle", function (event) {
        toggleField(this);
        rebuildFilters();
    });
    
    /*
     * Perform the AJAX call to get a list of parameters, and enable/disable them
     * If "init" is true then this is the initial page load, and we need to populate the fields rather than toggle them.
     */
    function updateSummaryData(init) {
        var init = typeof init !== 'undefined' ? init : false;
        var qstring=($.param($.map(params, function(v, k) { return ($.type(v) === "array") ? $.map(v, function(v) { return {name: k, value: v} }) : {name: k, value: v} })));
        if (! init) {
            if (request.readyState < 3) {
                request.abort();
            }
        }
        request=$.ajax({
            type : 'GET',
            url : stoqsQuery + '?' + qstring,
            success: function (data) {
                setUrls();
                for (var key in data) {
                    if (init == true) {
                        if (key == 'platforms') {
                            $.each(data[key], function (index, value) {
                                                    $('#platform-table > tbody:last').append('<tr id="' + value[1] +'">' +
                                                              '<th><input type="checkbox"></th>' +
                                                              '<th class="platform"><button class="btn btn-mini stoqs-toggle">'+ value[0] +'</button></th>' +
                                                              '</tr>');
                            });
                        }
                        else if (key == 'parameters') {
                            $.each(data[key], function (index, value) {
                                                    $('#parameter-table > tbody:last').append('<tr id="' + value[1] +'">' +
                                                              '<th><input type="checkbox"></th>' +
                                                              '<th><input name="'+key+'" type="radio"></th>' +
                                                              '<th class="parameter"><button class="btn btn-mini stoqs-toggle">'+ value[0] +'</button></th>' +
                                                              '</tr>');
                            });
                        }
                        else if (key == 'time') { 
                            var start=new Date(data[key][0]);
                            var end=new Date(data[key][1]);
                            $('#start-time').val($.format.date(start,'yyyy-MM-dd hh:mm:ss'));
                            $('#end-time').val($.format.date(end,'yyyy-MM-dd hh:mm:ss'));
                            makeSlider('slider-' + key, key, data[key])
                        }
                        else if (key == 'depth') {
                            $('#start-' + key).val(Math.round(data[key][0]*10)/10);
                            $('#end-' + key ).val(Math.round(data[key][1]*10)/10);
                            makeSlider('slider-' + key, key, data[key])
                        }
                    } else {
                        if (key == 'platforms') {
                            var ids=[];
                            $.each(data[key], function (index, value) {
                                // Here we need to enable those that are still valid.
                                var element=$('#' + value[1]);
                                enableButton($('button', element)); // Enable the button in the table row
                                ids.push(value[1]);
                            });
                            $('#platform-table > tbody > tr').each(function (index, elem) { 
                                if ($.inArray((elem.id).toString(), ids) == -1) {
                                    disableButton($('button', $(elem))); // Disable the button in the table row
                                }
                            });
                        }
                        else if (key == 'parameters') {
                            var ids=[];
                            $.each(data[key], function (index, value) {
                                // Here we need to enable those that are still valid.
                                var element=$('#' + value[1]);
                                enableButton($('button', element)); // Enable the button in the table row
                                ids.push(value[1]);
                            });
                            $('#parameter-table > tbody > tr').each(function (index, elem) { 
                                if ($.inArray((elem.id).toString(), ids) == -1) {
                                    disableButton($('button', $(elem))); // disable the button in the table row
                                }
                            });
                        }
                        else if (key == 'time') {
                            var start=new Date(data[key][0]);
                            var end=new Date(data[key][1]);
                            $('#start-time').val($.format.date(start,'yyyy-MM-dd hh:mm:ss'));
                            $('#end-time').val($.format.date(end,'yyyy-MM-dd hh:mm:ss'));
                        }
                        else if (key == 'depth') {
                            $('#start-depth').val(Math.round(data[key][0]*10)/10);
                            $('#end-depth').val(Math.round(data[key][1]*10)/10);
                        }
                    }
                    
                }
                $('#result_count').html(data['count']);
            },
            dataType: "json"
        });
    }
    

    
    
    $(function () { 
        // Initialize the accordian fields.
        $(".collapse").collapse(); // Collapse the accordian fields.
        
        // Adjust the height of the map div to 500px
        $('#map').height(500);
        
        // Add this behavior to all text fields, so when someone clicks on a field it highlights 
        // all the data so it's easy to copy to the clipboard.
        $(document).on('focus', 'input[type=text]', function(e) {
            // Select field contents
            var t=this
            // This has to be done after 100ms so that standard bootstrap functionality happens first.
            setTimeout(function() { t.select()}, 100);
        });
        
        /* 
         * Setup OpenLayers with some default background layers.
         */
          OpenLayers.IMAGE_RELOAD_ATTEMPTS = 4;
          OpenLayers.Util.onImageLoadError = function() {this.style.display="none"; };
          var map = null; 
          var options = {
               projection: new OpenLayers.Projection("EPSG:900913"),
               displayProjection: new OpenLayers.Projection("EPSG:4326"),
               units: "m",
               maxResolution: 156543.0339,
               maxExtent: new OpenLayers.Bounds(-20037508.34, -20037508.34,
                                                 20037508.34, 20037508.34)
          };
          map = new OpenLayers.Map('map',options);
          var esri=new OpenLayers.Layer.ArcGIS93Rest("Ocean Basemap",
            "http://services.arcgisonline.com/ArcGIS/rest/services/Ocean_Basemap/MapServer/export",
            {layers: "0"} );
          var osm=new OpenLayers.Layer.OSM("OpenStreetMap");
          var gphy = new OpenLayers.Layer.Google(
              "Google Physical",
              {'type': google.maps.MapTypeId.TERRAIN,
               'sphericalMercator': true}
          );
          var gmap = new OpenLayers.Layer.Google(
              "Google Streets", // the default
              {'sphericalMercator': true,
               numZoomLevels: 20}
          );
          var ghyb = new OpenLayers.Layer.Google(
              "Google Hybrid",
              {'type': google.maps.MapTypeId.HYBRID, 
               numZoomLevels: 20,
               'sphericalMercator': true}
          );
          var gsat = new OpenLayers.Layer.Google(
              "Google Satellite",
              {'type': google.maps.MapTypeId.SATELLITE, 
               numZoomLevels: 15,
               'sphericalMercator': true}
          );
          map.addLayers([esri,osm,gsat,gphy,ghyb,gmap]);

          /*
           * Maptrack layers selected by UI - following the method in activityWMS.html
           */
          track_lines = new OpenLayers.Layer.WMS(
                    "track_lines",
                    "http://172.16.130.129/cgi-bin/mapserv",
                    { layers: 'track_lines',
                      map: '/tmp/activity_zSZccr.map',
                      //map: '{{ mappath }}',
                      transparent: 'True' },
                    { units: 'degrees',
                     // displayInLayerSwitcher: false,
                      projection: "EPSG:900913",
                      reproject: false,
                      visibility: true,
                      displayOutsideMaxExtent: true });
          map.addLayer(track_lines); 



          map.setCenter(new OpenLayers.LonLat(-13594478.3, 4411945.3), 9);
          map.addControl(new OpenLayers.Control.LayerSwitcher());
          map.addControl(new OpenLayers.Control.MousePosition());
          map.addControl(new OpenLayers.Control.PanZoomBar());

          /*
           *
           */
          updateSummaryData(true);
          
          $('body').on('change', '.slider-values', function (e) {
            var $slider=$('#slider-' + this.id.split('-').reverse()[0])
            var setting=$slider.data().reverseformatter($(this).val());
            var pos=0;
            if (this.id.split('-')[0] == 'start') {
                pos=0
            } else {
                pos=1
            }
            var oldvalue=$slider.slider('values',pos);
            var result=$slider.slider('values',pos,[setting]);
            if (Math.abs(setting-result) > 1) {
                jAlert('The data entered was not within the specified range, or exceeds the valid precision for this field. ' +
                        'the field has been reset to its original value.')
                $slider.slider("values",pos,[oldvalue])
            }
        });
          
          
          });
    </script>
  </body>
</html>
