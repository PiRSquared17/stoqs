<!DOCTYPE html> <!--  HTML5 Doctype -->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>{{request.META.dbAlias}}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- The styles -->
    <link href="{{STATIC_URL}}bootstrap/css/bootstrap.css" rel="stylesheet">
    <style>
      body {
        padding-top: 60px;  /* 60px to make the container go all the way to the bottom of the topbar */
        height: 100%;       /* make the percentage height on flot placeholder work */
      }
      .stoqs-toggle {
        width: 100%;
      }
      .zoom-toggle {
        width: 100%;
      }
      .stoqs-parameter-toggle {
        width: 50%;
      }

    #zoomnavigation .button {
        position: absolute;
        cursor: pointer;
    }
    #zoomnavigation div.button {
        font-size: smaller;
        color: #999;
        background-color: #eee;
        padding: 2px;
    }
        .rotate-90 {
            -moz-transform: rotate(-90deg);  /* FF3.5+ */
            -o-transform: rotate(-90deg);  /* Opera 10.5 */
            -webkit-transform: rotate(-90deg);  /* Saf3.1+, Chrome */
        }
      th {
        align: center; /* Doesn't seem to work '*/
      }
<!--
        div.dataTables_length label {
            width: 460px;
            float: left;
            text-align: left;
        }
 
        div.dataTables_length select {
            width: 75px;
        }
 
        div.dataTables_filter label {
            float: right;
            width: 460px;
        }
 
        div.dataTables_info {
            padding-top: 8px;
        }
 
        .dataTables_paginate {
            float: right;
            margin: 0;
        }
 
        table {
            margin: 1em 0;
            clear: both;
        }
-->
    </style>
    <link href="{{STATIC_URL}}bootstrap/css/bootstrap-responsive.css" rel="stylesheet">
    <link type="text/css" href="{{ STATIC_URL }}jquery/css/custom-theme/jquery-ui-1.8.17.custom.css" rel="stylesheet" />    
    <link type="text/css" href="{{ STATIC_URL }}jquery/css/jquery.dataTables.css" rel="stylesheet" />    
    

    <!-- The HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
      <script language="javascript" type="text/javascript" src="{{STATIC_URL}}excanvas_r3/excanvas.js"></script>
    <![endif]-->

    <!-- The fav and touch icons -->
    <link rel="shortcut icon" href="{{STATIC_URL}}media/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="{{STATIC_URL}}bootstrap/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="{{STATIC_URL}}bootstrap/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="{{STATIC_URL}}bootstrap/ico/apple-touch-icon-57-precomposed.png">

    {% if google_analytics_code %}
    <!-- Google Analytics -->
    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', '{{google_analytics_code}}']);
        _gaq.push(['_trackPageview']);

        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>
    {% endif %}
  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="http://www.mbari.org"><img src="{{STATIC_URL}}images/mbari_bw_logo.gif"></a>
          <a class="brand" href="#">{{request.META.dbAlias}}</a>
          <div class="nav-collapse">
            <ul class="nav">
              <li><a href="{% url show-default %}"><i class="icon-list-alt icon-white"></i> Campaign list</a></li>
            </ul>
            <!--
            <form action="">
                <input type="text" placeholder="Search" />
            </form>
            -->
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

  <div class="container-fluid">

    <div class="row-fluid">

        <div class="span6">

            <div class="accordion well" id="accordion1">

                <div class="accordian-group">
                    <div class="accordian-heading">
                        <h3><a id="map-anchor" class="accordion-toggle" data-toggle="collapse" data-parent="#accordion1" href="#collapseMap">
                        Map
                        </a></h3>
                    </div>
                    <div id="collapseMap" class="accordion-body collapse in">
                        <div class="accordion-inner">
                            <div class="row-fluid" id="map"></div>
                            <p>
                                <label class="checkbox">
                                    <input type="checkbox" id="zoomtoextentonupdate" checked /> Zoom to extent on update
                                </label>
                            </p>
                            <p>
                                <div id="query-stats" class="ajax-wait"></div>
                                <label class="checkbox">
                                    <input type="checkbox" id="getactualcount" /> Get actual count
                                </label>
                            </p>
                            <div id="samplePoint"></div>
                        </div>
                    </div>
                </div><!-- accordian-group -->

                <div class="accordian-group">
                    <div class="accordian-heading">
                        <h3><a id="sample-anchor" class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseSample">
                        Sample Data Access
                        </a></h3>
                    </div>
                    <div id="collapseSample" class="accordion-body collapse in">
                        <div class="accordion-inner">
                            <span id="sample-instructions">Click on Sample locations in time-depth plot to get information here</span>
                            <table id="sample-table" class="table table-striped table-bordered">
                                <thead>
                                    <tr>
                                    </tr>
                                </thead> 
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div><!-- accordian-group -->

                <div class="accordian-group">
                    <div class="accordian-heading">
                        <h3><a id="data-access-anchor" class="accordion-toggle" data-toggle="collapse" data-parent="#accordion1" href="#collapseDataAccess">
                        Measurement Data Access
                        </a></h3>
                    </div>
                    <div id="collapseDataAccess" class="accordion-body collapse in">
                        <div class="accordion-inner">

                            <ul class="nav nav-tabs">
                                {% for format in formats %}
                                    {% if format.0 = 'kml' %}
                                <li class="active"><a href="#{{format.0}}" data-toggle="tab">{{format.0}}</a></li>
                                    {% else %}
                                <li><a href="#{{format.0}}" data-toggle="tab">{{format.0}}</a></li>
                                    {% endif %}
                                    
                                {% endfor %}            
                            </ul>
                            <div class="tab-content">
                                {% for format in formats %}
                                    {% if format.0 = 'kml' %}
                                <div class="tab-pane active" id="{{format.0}}">
                                    {% else %}
                                <div class="tab-pane" id="{{format.0}}">
                                    {% endif %} 
                                    <table>
                                        <tr>
                                            <th><a target="_blank" id="{{format.0}}-link" href="" title="Click to view"><img src="{{STATIC_URL}}images/{{format.0}}-icon.png"/></a></th>
                                            <th valign="top"><h4>&nbsp;{{format.1}}</h4></th>
                                        </tr>
                                    </table>
                                    {% if format.0 = 'kml' %}
                                        <div align="center">
                                        <span id="kml-parameter"></span>
                                        <form align="center" class="form-inline">
                                            <input id="cmin" type="text" class="input-small" style="text-align:right;" title="Initial min value is 2.5 percentile" />
                                            <img style="vertical-align:middle;"src="{{STATIC_URL}}images/jetplus_bar.png" title="jetplus.pal" />
                                            <input id="cmax" type="text" class="input-small" title="Initial max value is 97.5 percentile" />
                                        </form>
                                        </div>
                                        <pre id="{{format.0}}-field"></pre>
                                    {% else %}
                                        <pre id="{{format.0}}-field"></pre>
                                    {% endif %}
                                </div>
                                {% endfor %}            
                            </div>
                            </ul>
                        </div>
                    </div>
                </div><!-- accordian-group -->

            </div><!-- accordian well -->

        </div><!-- span6 -->
        
        <div class="span6">
            <div class="accordion well" id="accordion2">

                <div class="accordian-group">
                    <div class="accordian-heading">
                        <h3><a id="time-depth-anchor" class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseOne">
                        Time Depth
                        </a></h3>
                    </div>
                    <div id="collapseOne" class="accordion-body collapse in">
                        <div class="accordion-inner">
                            <div id="time-depth-plot" style="height:400px" class="disabled row-fluid">
                                <!-- <div align="center" style="float:left;width:10%;height:90%;">
                                    <div class="rotate-90">Depth (m)</div>
                                </div>  -->
                                <div id="time-depth-flot" style="width:100%;height:90%;" class="disabled" title="Click and drag to select a time-depth range"></div>
                                <div class="row"><p align="center">Time (GMT)</p></div>
                                <div class="row">
                                    <div class="span2">
                                        <label class="checkbox disabled">
                                            <input type="checkbox" id="displayparameterplatformdata" disabled><span id="contourtext">Contour data values</span>
                                        </label>
                                    </div>
                                    <div class="span3" id="zoomnavigation"></div>
                                    <div class="span4" id="sectioncolorbar" style="float:right;"></div>
                                </div>
                                <div class="span12">
                                    <button id="zoomed-button" class="btn btn-mini zoom-toggle disabled">Zoomed</button>
                                </div>
                            </div>
                            <input type="hidden" id="start-ems" "name="start-ems" />
                            <input type="hidden" id="start-time" "name="start-time" />
                            <input type="hidden" id="end-ems" name="end-ems" /> 
                            <input type="hidden" id="end-time" name="end-time"> 
                            <input type="hidden" id="start-depth" "name="start-depth" />
                            <input type="hidden" id="end-depth" name="end-depth" /> 
                        </div>
                    </div>
                </div><!-- accordian-group -->


                <div class="accordian-group">
                    <div class="accordian-heading">
                        <h3><a id="parameters-anchor" class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseTwo">
                        Parameters
                        </a></h3>
                    </div>
                    <div id="collapseTwo" class="accordion-body collapse in">
                        <div class="accordion-inner">
                            <table id="parameter-table" class="table table-condensed">
                                <thead>
                                    <tr>
                                        <td style="text-align:center;font-weight:bold;">Name</td>
                                        <td style="text-align:center;font-weight:bold;">Standard Name</td>
                                    </tr>
                                </thead>                             
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div><!-- accordian-group -->

                <div class="accordian-group">
                    <div class="accordian-heading">
                        <h3><a id="parameter-values-anchor" class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseParameterValues">
                        Parameter Values
                        </a></h3>
                    </div>
                    <div id="collapseParameterValues" class="accordion-body collapse in">
                        <div class="accordion-inner">
                            <div class="span6">
                                Histogram display: 
                                <input type="checkbox" id="showsigmatparametervalues" checked /> sea_water_sigma_t
                                <input type="checkbox" id="showstandardnameparametervalues" /> Standard Names
                                <input type="checkbox" id="showallparametervalues" /> All Parameters
                            </div>
                            <div class="span4" class="float:right">
                                <button id="resetparametervaluesselections" class="btn btn-mini disabled" style="float:right;50%"/> Reset Parameter Value Selections</button> 
                            </div>
                            <table id="parameter-value-table" class="table table-condensed">
                            </table>
                        </div>
                    </div>
                </div><!-- accordian-group -->

                <div class="accordian-group">
                    <div class="accordian-heading">
                        <h3><a id="platforms-anchor" class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseThree">
                        Platforms
                        </a></h3>
                    </div>
                    <div id="collapseThree" class="accordion-body collapse in">
                        <div class="accordion-inner">
                            <table id="platform-table" class="table table-condensed">
                              <tbody>
                              </tbody>
                            </table>                                
                        </div>
                    </div>
                </div><!-- accordian-group -->

            </div><!-- accordian well -->

        </div><!-- span -->

    </div><!-- row-fluid -->

  </div> <!-- container -->

    <!-- The javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/javascript" src="{{ STATIC_URL }}jquery/js/jquery-1.7.1.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}jquery/js/jquery-ui-1.8.17.custom.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}jquery/js/jquery.ui.touch-punch.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}jquery/js/jquery.dateFormat-1.0.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}jquery/js/jquery.flot.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}jquery/js/jquery.flot.selection.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}jquery/js/jquery.flot.resize.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}jquery/js/jquery.flot.image.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}jquery/js/jquery.flot.navigate.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}jquery/js/jquery.dataTables.min.js"></script>
    <script src="{{STATIC_URL}}bootstrap/js/bootstrap-transition.js"></script>
    <script src="{{STATIC_URL}}bootstrap/js/bootstrap-alert.js"></script>
    <script src="{{STATIC_URL}}bootstrap/js/bootstrap-modal.js"></script>
    <script src="{{STATIC_URL}}bootstrap/js/bootstrap-dropdown.js"></script>
    <script src="{{STATIC_URL}}bootstrap/js/bootstrap-scrollspy.js"></script>
    <script src="{{STATIC_URL}}bootstrap/js/bootstrap-tab.js"></script>
    <script src="{{STATIC_URL}}bootstrap/js/bootstrap-tooltip.js"></script>
    <script src="{{STATIC_URL}}bootstrap/js/bootstrap-popover.js"></script>
    <script src="{{STATIC_URL}}bootstrap/js/bootstrap-button.js"></script>
    <script src="{{STATIC_URL}}bootstrap/js/bootstrap-collapse.js"></script>
    <script src="{{STATIC_URL}}bootstrap/js/bootstrap-carousel.js"></script>
    <script src="{{STATIC_URL}}bootstrap/js/bootstrap-typeahead.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}OpenLayers-2.11/OpenLayers.js"></script> 
    <!--<script type="text/javascript" src="http://maps.google.com/maps/api/js?v=3.2&amp;sensor=false"></script> -->
    <script type="text/javascript">
    
    var stoqsQuery='{{site_uri}}{% url stoqs-query-summary dbAlias=request.META.dbAlias %}';
    var params={}
    var initData;
    var zoomedData;
    var request=''
    var map = null; 
    var kmlurl;
    var parametervalues={};     // This should probably be a session variable
    var polyLayer = new OpenLayers.Layer.Vector( "Polygon" );
    var timedepthplot;
    var options_stack = [];
    var zoom_xy_stack = [];
    var stack_depth = 0;
    var simpledepthtime_options;
    var simpledepthtime_options_zoom;
    
    // Called with an element that was selectable, should make that element non-selectable.
    function disableButton(element) {
        if (! $(element).is('.disabled')) {
            $(element).removeClass('btn-primary');      // Unselect if it's selected.
            $(element).addClass('disabled');            // Add the disabled class to it.
            $(element).attr('title', ' ').tooltip('fixTitle').tooltip('show');     // Remove tooltip
        }
    }
    
    // Called with an element that was selectable, should make that element selectable.
    function enableButton(element) {
        if ($(element).is('.disabled')) {
            $(element).removeClass('disabled');
            $(element).attr('title', 'Click to Select').tooltip('fixTitle').tooltip('hide');     // Add generic tooltip
        }
    }

    function setKMLlinks() {
        var cmincmax = ''
        if ($('#cmin').val() && $('#cmax').val()) {
            cmincmax = '&cmin=' + $('#cmin').val() + '&cmax=' + $('#cmax').val();
        }
        $('#kml-field').text(kmlurl + cmincmax);
        $('#kml-link').attr('href',kmlurl + cmincmax);
    }

    function getMPparms(params) {
        // Construct querystring for measuredparameter REST request, mapping params to Django queries for the MP table
        // Good for .json, .csv, .tsv, .html responses
        var mp_param = '?';
        if (typeof params['parametername'] != 'undefined') {
            if (params['parametername'].length == 1) {
                mp_param = mp_param + 'parameter__name=' + params['parametername'][0] + '&';
            }
        }
        if (typeof params['platforms'] != 'undefined') {
            if (params['platforms'].length == 1) {
                mp_param = mp_param + 'measurement__instantpoint__activity__platform__name=' + params['platforms'][0] + '&';
            }
        }
        if (typeof params['start_time'] != 'undefined') {
            mp_param = mp_param + 'measurement__instantpoint__timevalue__gt=' + params['start_time'] + '&';
        }
        if (typeof params['end_time'] != 'undefined') {
            mp_param = mp_param + 'measurement__instantpoint__timevalue__lt=' + params['end_time'] + '&';
        }
        if (typeof params['min_depth'] != 'undefined') {
            mp_param = mp_param + 'measurement__depth__gte=' + params['min_depth'] + '&';
        }
        if (typeof params['max_depth'] != 'undefined') {
            mp_param = mp_param + 'measurement__depth__lte=' + params['max_depth'] + '&';
        }

        return mp_param
    }
    
    // Set the URL fields and buttons to use the current queried URL
    function setDataAccess(data) {
        var base_url = '{{site_uri}}{% url base-campaign dbAlias=request.META.dbAlias %}';
        var query_url = '{{site_uri}}{% url stoqs-query-ui dbAlias=request.META.dbAlias %}';
        var param=($.param($.map(params, function(v, k) { return ($.type(v) == "array") ? $.map(v, function(v) { return {name: k, value: v} }) : {name: k, value: v} })))
        if (param != '') {
            param = '?' + param;
        } 
        mp_param = getMPparms(params);

        var formats=[{% for format in formats %}'{{format.0}}'{% if not forloop.last %},{% endif %}{%endfor%}]
        // Iterate over the formats and update the fields/buttonts to use the new URL's to get the data.
        $.each(formats, function (index, value) {
            var url = query_url + value + param;
            if (value == 'sql') {
                $('#'+value+'-field').text(data['sql']);
            }
            else if (value == 'kml') {
                kmlurl = 'Select a Parameter to view your selection of O(10k) actual datavalues in Google Earth';
                if (typeof params['parametername'] != 'undefined') {
                    if (params['parametername'].length == 1) {
                        $('#kml-parameter').text(params['parametername'][0]);
                        $('#cmin').val(data['parameterminmax'][1]);
                        $('#cmax').val(data['parameterminmax'][2]);
                        kmlurl = url;
                    }
                    else if (params['parameterstandardname'].length == 1) {
                        $('#kml-parameter').text(params['parameterstandardname'][0]);
                        $('#cmin').val(data['parameterminmax'][1]);
                        $('#cmax').val(data['parameterminmax'][2]);
                        kmlurl = url;
                    }
                    else {
                        $('#kml-parameter').text('');
                        $('#cmin').val('');
                        $('#cmax').val('');
                    }
                }
                setKMLlinks();
            }
            else if (value == 'stoqstoolbox') {
                // Required parameters for stoqs_down as of stoqstoolbox release noted in the Matlab comment below
                var req_params = ['campaign', 'start_time', 'end_time', 'min_depth', 'max_depth', 'platforms', 'parametername', 'parameterstandardname'];
                var st_text = "% Copy and paste into a Matlab session where stoqstoolbox build 2012-11-21 or\n";
                st_text = st_text + "% later has been installed from https://code.google.com/p/stoqs/downloads\n\n";
                st_text = st_text + "campaign = '{{site_uri}}{% url base-campaign dbAlias=request.META.dbAlias %}';\n";
                $.each(req_params, function(k, v) {
                    if (typeof params[v] != "undefined") {
                        if (v.match(/depth$/)) {
                            // Numeric value, don't quote
                            st_text = st_text + v + " = " + params[v] + ";\n";
                        }
                        else {
                            if (v.match(/campaign/) && params[v].match(/https/)) {
                                st_text = st_text + v + " = '" + params[v].replace(/https/, 'http') + "';\n";
                            }
                            else {
                                st_text = st_text + v + " = '" + params[v] + "';\n";
                            }
                        }
                    }
                    else if (v != 'campaign') {
                        st_text = st_text + v + " = '';\n";
                    }
                });
                $('#'+value+'-field').text(st_text + "\ndata = stoqs_down(" + req_params.join() + ");\n");
            }
            // Queries made using measuredparameter REST requests - use mp_parm for Django queries for the measuredparameter table
            else if (value == 'json') {
                var url = base_url + 'measuredparameter.json' + mp_param;
                $('#'+value+'-field').text(url);
                $('#'+value+'-link').attr('href',url);
            }
            else if (value == 'csv') {
                var url = base_url + 'measuredparameter.csv' + mp_param;
                $('#'+value+'-field').text(url);
                $('#'+value+'-link').attr('href',url);
            }
            else if (value == 'tsv') {
                var url = base_url + 'measuredparameter.tsv' + mp_param;
                $('#'+value+'-field').text(url);
                $('#'+value+'-link').attr('href',url);
            }
            else if (value == 'html') {
                var url = base_url + 'measuredparameter.html' + mp_param;
                $('#'+value+'-field').text(url);
                $('#'+value+'-link').attr('href',url);
            }
            else {
                $('#'+value+'-field').text(url);
                $('#'+value+'-link').attr('href',url);
            }
        });
    }
    
    function toggleField(element) {
        var $element=$(element);
        if (! $(element).is('.disabled')) { // If it's disabled, then don't bother toggling it.
            if ($element.is('.btn-primary')) {
                $element.removeClass('btn-primary');
                if ($(element).hasClass('parametername')) {
                    $('#parameters-anchor').html('Parameters')
                }
                if ($(element).hasClass('parameterstandardname')) {
                    $('#parameters-anchor').html('Parameters')
                }
                if ($(element).hasClass('platform')) {
                    $('#platforms-anchor').html('Platforms')
                }
            } else {
                $element.addClass('btn-primary');
                if ($(element).hasClass('parametername')) {
                    $('#parameters-anchor').html('Parameter name: ' + $(element).html())
                }
                if ($(element).hasClass('parameterstandardname')) {
                    $('#parameters-anchor').html('Parameter standard_name: ' + $(element).html())
                }
                if ($(element).hasClass('platform')) {
                    $('#platforms-anchor').html('Platform: ' + $(element).html())
                }
            }
        }
    }
    
    function getUTCDateString(date) {
        // $.format.date(date,'yyyy-MM-dd hh:mm:ss') is broken in Safari, construct SQL friendly date string this way
        var mon = new String(date.getUTCMonth() + 1);
        mon = mon.replace(/\d+/g, function(m) {
           return "0".substr(m.length - 1) + m;
        });
        var day = new String(date.getUTCDate());
        day = day.replace(/\d+/g, function(m) {
           return "0".substr(m.length - 1) + m;
        });
        var hr = new String(date.getUTCHours());
        hr = hr.replace(/\d+/g, function(m) {
           return "0".substr(m.length - 1) + m;
        });
        var mn = new String(date.getUTCMinutes());
        mn = mn.replace(/\d+/g, function(m) {
           return "0".substr(m.length - 1) + m;
        });
        var se = new String(date.getUTCSeconds());
        se = se.replace(/\d+/g, function(m) {
           return "0".substr(m.length - 1) + m;
        });

        var date_str = date.getUTCFullYear() + '-' + mon + '-' + day;
        date_str = date_str + ' ' + hr + ':' + mn + ':' + se;

        return date_str
    }

    function makeSlider(divid, type, data) {
        if (type == 'time') {
            var start=new Date(data[0]);
            var end=new Date(data[1]);
            var max=Math.abs((start.getTime() - end.getTime()));
            var min=0
        } else if (type == 'depth') {
            // Float/Decimal type
            var min=Math.floor(data[0]*10000);
            var max=Math.ceil(data[1]*10000);
        }
        if (type == 'time') {
            var formatter=function (value) { 
                var start=new Date(data[0]);
                var cur=new Date(start.getTime() + value);
                return getUTCDateString(cur);
            };
            var reverseformatter=function (value) {
                var start=new Date(data[0]);
                try {
                    var end=new Date(value);
                } catch (err) {
                    var end=new Data(data[1]).getTime();
                }
                var cur=Math.abs((start.getTime() - end.getTime()));
                return cur;
            };
        } else if (type == 'depth') {
            // Float/Decimal type
            var formatter=function(value) { return value/10000; };
            var reverseformatter=function(value) { return value *10000; };
        }
        var options={max: max,
                     min: min,
                     values: [min, max],
                     range: true
        };
        
        var div=$('#' + divid);
        div.bind({
            slide : function (event, ui) { recordUpdatedValues(ui.values, divid, type, formatter, false); },
            slidechange:function (event, ui) { recordUpdatedValues(ui.values, divid, type, formatter, true); }
        })
        div.slider(options);
        
        div.data("reverseformatter", reverseformatter);
        if (typeof postaddfunc != "undefined") {
           //div.data("postaddfunction", postaddfunc);
        }
        return div;

    } // makeSlider()

    function enableContouring() {
        $('#displayparameterplatformdata').parent().removeClass('disabled');
        $('#displayparameterplatformdata').parent().tooltip('disable');
        $('#displayparameterplatformdata').removeAttr('disabled');
        if (typeof params['platforms'] != 'undefined') {
            if (params['platforms'].length == 1) {
                $('#contourtext').text('Contour ' + params['parametername'] + ' from ' + params['platforms'][0]);
            }
        }
    }

    function disableContouring() {
        $('#displayparameterplatformdata').parent().addClass('disabled');
        $('#displayparameterplatformdata').attr('disabled');
        //$('#displayparameterplatformdata').removeAttr('checked');
        $('#contourtext').text('Contour data values');
        $('#sectioncolorbar').html('');
    }

    function updateContourInfo() {
        if (typeof params['parametername'] != 'undefined') {
            console.log('parametername = ' + params['parametername']);
            if (params['parametername'].length == 1 ) {
                enableContouring();
            }
            else {
                disableContouring();
            }
        }
        else {
            disableContouring();
        }
    }

    function recordUpdatedValues(values, divid, type, formatter, updateTable) {
        var min=formatter(values[0])
        var max=formatter(values[1])
        $('#start-' + type).val(min)
        $('#end-' + type).val(max)
        if (updateTable) {
            rebuildFilters();
        }
    }
    
    function rebuildFilters() {
        params={}
        if ($('.btn-primary', $('#time-depth-plot')).length) {
            params['start_time']=$('#start-time').val()
            params['end_time']=$('#end-time').val()
            params['min_depth']=$('#start-depth').val()
            params['max_depth']=$('#end-depth').val()
        }

        params['parametername']=[]
        params['parameterstandardname']=[]
        params['platforms']=[]
        var regExp = new RegExp('--.+-sn');
        $('td',$('#parameter-table')).each(function (index, element) {
            if ($('.btn-primary', $(element)).length) {
                if ( $('.parametername', $(element)).length) {
                    params['parametername'].push(element.id);
                }
                if ( $('.parameterstandardname', $(element)).length) {
                    params['parameterstandardname'].push(element.id.replace(regExp,''));
                }
                $('#' + element.id + ' > button').attr('title', 'Click to unselect').tooltip('fixTitle');
            }
        });
        $('tr',$('#platform-table')).each(function (index, element) {
            if ($('.btn-primary', $(element)).length) {
                params['platforms'].push(element.id);
                $('#' + element.id + ' > td > button').attr('title', 'Click to unselect').tooltip('fixTitle');
            }
        });

        if (parametervalues) {
            valueText = ': ';
            for (var parameter in parametervalues) {
                // No CF stantard names end with '_MIN' or '_MAX' and none have upper case letters, so the convention
                // of adding these identifiers and taking them off should work.
                console.log(parameter);
                var min = parametervalues[parameter]['min'];
                var max = parametervalues[parameter]['max'];
                console.log(min, max);
                if (typeof min != 'undefined' && typeof max != 'undefined') {
                    params[parameter + '_MIN'] = min;
                    params[parameter + '_MAX'] = max;
                    valueText = valueText + parameter + ': ' + min.toPrecision(4) + ' to ' + max.toPrecision(4) + ', ';
                    $('#resetparametervaluesselections').removeClass('disabled');
                    $('#resetparametervaluesselections').addClass('btn-primary');
                }
            };
            valueText = valueText.substring(0, valueText.length - 2); 
            $('#parameter-values-anchor').html('Parameter Values' + valueText);
        }

        updateContourInfo();
        updateSummaryData();
        polyLayer.removeAllFeatures();

    } // rebuildFilters()
    
    function refreshMap() {
        track_lines.redraw(true);
        sample_points.redraw(true);
    }

    $(document).on('click', ".stoqs-toggle", function (event) {
        toggleField(this);
        rebuildFilters();
    });

    function resetZoomedValues(resetData) {
            // Reset zoom to saved resetData values
            $('#start-depth').val(resetData['depth'][0]);
            $('#end-depth').val(resetData['depth'][1]);

            var start=new Date(resetData['time'][0]);
            $('#start-ems').val(start.getTime());
            $('#start-time').val(getUTCDateString(start));
            var end=new Date(resetData['time'][1]);
            $('#end-ems').val(end.getTime());
            $('#end-time').val(getUTCDateString(end));

    }

    // Special handling for unzooming the time-depth-plot
    $("#zoomed-button").click(function() {
        if ( $('.btn-primary', $('#time-depth-plot').length) ) {
            resetZoomedValues(initData);
            options_stack = [];
            zoom_xy_stack = [];
            stack_depth = 0;
            simpledepthtime_options_zoom = simpledepthtime_options;
            rebuildFilters();
            $("#zoomed-button").removeClass('btn-primary');
            $("#zoomed-button").addClass('disabled');
            $('#zoomed-button').attr('title', ' ').tooltip('fixTitle').tooltip('hide');
            $('#time-depth-anchor').html('Time Depth')
        }
    });

    $('#getactualcount').on('click', function (event) {
        if ( ! $('#getactualcount').is(':checked')) {
            rebuildFilters();
        }
    });

    $('#showsigmatparametervalues').on('click', function (event) {
        rebuildFilters();
    });

    $('#showstandardnameparametervalues').on('click', function (event) {
        rebuildFilters();
    });

    $('#showallparametervalues').on('click', function (event) {
        rebuildFilters();
    });

    $('#displayparameterplatformdata').on('click', function (event) {
        rebuildFilters();
    });

    $('#cmin').on('keypress', function (event, previousText) {
        setTimeout(setKMLlinks());
    });

    $('#cmax').on('keypress', function (event, previousText) {
        setTimeout(setKMLlinks());
    });

    $("#resetparametervaluesselections").click(function() {
        if ( $('#resetparametervaluesselections').hasClass('btn-primary')) {
            $("#resetparametervaluesselections").removeClass('btn-primary');
            $("#resetparametervaluesselections").addClass('disabled');
            parametervalues = {};
            rebuildFilters();
        }
    });

    var simpledepthtime_options = { grid: { 
                                        backgroundColor: "rgb(192, 211, 228)",      //c0d3e4
                                        hoverable: true, 
                                        clickable: true 
                                    },
                                    xaxis: { mode: "time" },
                                    yaxis: {
                                        transform: function (v) { return -v; },
                                        inverseTransform: function (v) { return -v; }
                                    },
                                    series: {
                                        lines: { show: true, fill: false, lineWidth: 1 },
                                        points: { show: false, fill: false },
                                        shadowSize: 0
                                    },
                                    legend: { show: false },
                                    selection: { mode: "xy" },
                                    //zoom: { interactive: true },
                                    //pan: { interactive: true }
                                  };


    /* Default class modification for DataTable*/
    $.extend( $.fn.dataTableExt.oStdClasses, {
        "sSortAsc": "header headerSortDown",
        "sSortDesc": "header headerSortUp",
        "sSortable": "header",
        "sWrapper": "dataTables_wrapper form-inline",
        "sPaginationType": "full_numbers",
        "bJQueryUI": true,
        "aoColumnDefs": [ { "sWidth": "10%", "aTargets": [ -1 ] }
    ]
    });

    function showTooltip(x, y, contents) {
        $('<div id="tooltip">' + contents + '</div>').css( {
            position: 'absolute',
            display: 'none',
            top: y + 5,
            left: x + 5,
            border: '1px solid #fdd',
            padding: '2px',
            'background-color': '#fee',
            opacity: 0.80
        }).appendTo("body").fadeIn(200);
    }

    $("#time-depth-flot").bind("plothover", function (event, pos, item) {
        if (pos.x && pos.y) {
            $("#x").text(pos.x.toFixed(2));
            $("#y").text(pos.y.toFixed(2));
        }
        else {
            return;
        }

        if (item) {
            if (typeof previousPoint != 'undefined') {
                if (previousPoint != item.dataIndex) {
                    previousPoint = item.dataIndex;
                    
                    $("#tooltip").remove();
                    var x = item.datapoint[0].toFixed(2),
                        y = item.datapoint[1].toFixed(2);
               
                    showTooltip(item.pageX, item.pageY,
                                item.series.label);
                }
            }
        }
        else {
            $("#tooltip").remove();
            previousPoint = null;            
        }
    });

    function showSampleData(label) {
            //http://172.16.130.129:8000/stoqs_october2010/sample.json?instantpoint__activity__name__contains=Dorado389_2010_278_01_278_01&name=4.0
            var sample_url = '{{site_uri}}{% url show-sample-datatable dbAlias=request.META.dbAlias format=".json" %}';
            sample_url = sample_url + '?instantpoint__activity__name__contains=' + label.split(' ')[0] + '&name=' + label.split(' ')[1];
            
            var cols = ['depth', 'filter diam', 'filter pore size', 'lon', 'lat', 'activity name', 'time', 'lab',
                        'name', 'res.', 'purpose', 'type', 'volume'];
            var ths = '<tr>';
            $.each(cols, function (index, value) {
                ths = ths + '<th>' + value + '</th>';
            });
            ths = ths + '</tr>';
            $('#sample-table > thead').html(ths);

            $("#sample-table").dataTable( {
                "sDom": "<'row'<'span6'l><'span6'f>r>t<'row'<'span6'i><'span6'p>>",
                "bProcessing": true,
                "bDestroy":    true,
                "sAjaxSource": sample_url
            });
            $('#sample-instructions').text('')
            if (! $('#collapseSample').hasClass('in')) {
                $('#sample-anchor').click();
            }
    }

    function showQuickLooks(label) {
            // http://172.16.130.135:8000/stoqs_may2012/resourceactivity.json?resourcetype__name=quick_look&activityresource__activity__name__contains=Dorado389_2012_150_00_150_00_decim
            //var quicklook_url = '{{site_uri}}{% url show-resourceactivity dbAlias=request.META.dbAlias format=".json" %}?resourcetype__name=quick_look&';
            var quicklook_url = '{{site_uri}}{% url show-quicklookplots dbAlias=request.META.dbAlias %}?';
            quicklook_url = quicklook_url + 'activityresource__activity__name__contains=' + label.split(' ')[0];
            //var nwin = window.open(quicklook_url, '', 'height=800,width=1000');
            //if (window.focus) {
                //nwin.focus();
            //}
    }
                
    $("#time-depth-flot").bind("plotclick", function (event, pos, item) {
        // This method of providing quick look plots is annoying as click-n-drag operations will sometimes trigger a plotclick
        if (item) {
            // Crude test whether sample or activity click, activities 2nd element may be '(stride=..'
            //console.log(item.series.label)
            if (item.series.label.split(' ').length == 2) {
                if (item.series.label.split(' ')[1].indexOf('(') == -1) {
                    showSampleData(item.series.label)
                }
                else if (item.series.label.split(' ')[1].indexOf('(') != -1) {
                    // Crude test that we have an activity name
                    showQuickLooks(item.series.label)
                }
            }
        }
    });

    function getDataset(data, x1, x2) {
        // Return a dataset for flot for only the data between times x1 and x2
        var dataset = [];
        var platform_seen = [];
        if ( ! data ) {
            return;
        }
        $.each(data['platforms'], function (index, platform_value) {
            // Now add each activity for this platform - separated so that they are not connected with a line
            $.each(data['simpledepthtime']['sdt'][platform_value[0]], function (label, depth_time_series) {
                var rec = [];
                //console.log('Checking time for ' + platform_value[0] + ' label = ' + label + ', times between ' + x1 + ' and ' + x2);
                subset_dts = []
                $.each(depth_time_series, function (index, td) {
                    // From each activity push only the times between x1 & x2, inclusive
                    if (td[0] >= x1 && td[0] <= x2) {
                        subset_dts.push(td);
                    }
                });

                if (subset_dts.length > 0) {
                    if (! platform_seen[platform_value[0]]) {
                        //rec["label"] = platform_value[0];
                        platform_seen[platform_value[0]] = true;
                    }
                    //rec["label"] = label;
                    //rec["data"] = depth_time_series;
                    //rec["color"] = "#" + data['simpledepthtime']['colors'][platform_value[0]];
                    //console.log('rec["label"] = ' + rec["label"]);
                    //console.log('rec["data"] = ' + rec["data"]);
                    //console.log('rec["color"] = ' + rec["color"]);
                    //dataset.push(rec);
                    dataset.push({'label': label, 'data': depth_time_series, 'color': "#" + data['simpledepthtime']['colors'][platform_value[0]]});
                }
            });
        });

        // Add the sample locations, each with a label
        $.each(data['sampledepthtime'], function (index, sample) {
            sample["color"] = "#000000";
            sample["fillColor"] = "#ffffff";
            sample["points"] = {show: true, fill: true, lineWidth: 1};
            sample["lines"] = {show: false};
            sample["hoverable"] = true;
            sample["clickable"] = true;
            dataset.push(sample);
        });

        return dataset;

    } // getDataset()

    function collectHistData(histdata, platform, color, activity, histbyactivity) {
        var rec = [];
        rec["label"] = activity;
        rec["color"] = color;
        rec["data"] = histbyactivity['hist'];
        rec["data"] = histbyactivity['hist'];
        rec["bars"] = { show: true, barWidth: histbyactivity['binwidth'], fill: true, fillColor: color };
        histdata.push(rec);
        return histdata;
    }

    function addSelectedParameterValue(histdata, parameter) {
        var rec = [];
        rec["color"] = '#0f0000';
        console.log(parametervalues[parameter]);
        rec["data"] = [[parametervalues[parameter]['min'], 100000], [parametervalues[parameter]['max'], 100000]];
        console.log(rec['data']);
        binwidth = parametervalues[parameter]['max'] - parametervalues[parameter]['min'];
        rec["bars"] = { show: true, barWidth: binwidth, fill: true, fillColor: '#0f0f0f' };
        histdata.push(rec);
        return histdata;
    }
    
    function plotHistData(parameter, histdata) {
        $.plot($("#" + parameter + "-histogram-flot"), histdata, {
            series: {
                lines: { show: false }
            },
            legend: { show: false },
            selection: { mode: "x" },
            hoverable: true
        });
    }

    function ZoomIn(event, ranges) {
        // clamp the zooming to prevent eternal zoom
        if (ranges.xaxis.to - ranges.xaxis.from < 0.00001)
            ranges.xaxis.to = ranges.xaxis.from + 0.00001;
        if (ranges.yaxis.to - ranges.yaxis.from < 0.00001)
            ranges.yaxis.to = ranges.yaxis.from + 0.00001;

        // Save this zoom level
        stack_depth++;
        options_stack.push(simpledepthtime_options_zoom);
        zoom_xy_stack.push([ $('#start-ems').val(), $('#end-ems').val(), $('#start-depth').val(), $('#end-depth').val() ]);
        console.log('stack_depth = ' + stack_depth);
        console.log('options_stack = ' + options_stack);
        console.log('zoom_xy_stack = ' + zoom_xy_stack);

        // Save the zoomed values
        $('#start-depth').val(Math.round(ranges.yaxis.from*100)/100);
        $('#end-depth').val(Math.round(ranges.yaxis.to*100)/100);

        $('#start-ems').val(ranges.xaxis.from);
        var ds = new Date(ranges.xaxis.from);
        $('#start-time').val(getUTCDateString(ds));

        $('#end-ems').val(ranges.xaxis.to);
        var de = new Date(ranges.xaxis.to);
        $('#end-time').val(getUTCDateString(de))

        simpledepthtime_options_zoom = $.extend(true, {}, simpledepthtime_options, {
                                                              xaxis: { min: ranges.xaxis.from, max: ranges.xaxis.to },
                                                              yaxis: { min: ranges.yaxis.from, max: ranges.yaxis.to } 
                                                          });

        // Apply new depth & time ranges to the query and redraw the plot in rebuildFilters()
        $('#zoomed-button').removeClass('disabled'); 
        $('#zoomed-button').addClass('btn-primary');
        $('#zoomed-button').attr('title', 'Click to unzoom to original extent. Right-click on plot to unzoom to last zoom level.').tooltip('fixTitle').tooltip('hide');
        rebuildFilters();
        var dtLabel = 'Time: ' + $('#start-time').val() + ' to ' + $('#end-time').val();
        dtLabel = dtLabel + ' Depth: ' + $('#start-depth').val() + ' to ' + $('#end-depth').val();
        $('#time-depth-anchor').html(dtLabel);
    }

    function ZoomOut() {
        if (stack_depth > 0 ) {
            // Pop options from options stack to restore previous zoom level 
            stack_depth--;
            simpledepthtime_options_zoom = options_stack.pop();
            var zoom_xy = zoom_xy_stack.pop();
            console.log('stack_depth = ' + stack_depth);
            console.log('zoom_xy = ' + zoom_xy);
            $('#start-ems').val(zoom_xy[0]);
            $('#end-ems').val(zoom_xy[1]);
            $('#start-depth').val(zoom_xy[2]);
            $('#end-depth').val(zoom_xy[3]);
        
            rebuildFilters();
        } 
        // return false to suppress the right-mouse context menu from appearing 
        return false
    }

    $("#time-depth-flot").bind("plotselected", ZoomIn);
    $("#time-depth-flot").bind('contextmenu',  ZoomOut);


    /*
     * Perform the AJAX call to get a list of parametername and parameterstandardname, and enable/disable them
     * If "init" is true then this is the initial page load, and we need to populate the fields rather than toggle them.
     */
    function updateSummaryData(init) {
        var init = typeof init !== 'undefined' ? init : false;
        var qstring=($.param($.map(params, function(v, k) { return ($.type(v) === "array") ? $.map(v, function(v) { return {name: k, value: v} }) : {name: k, value: v} })));
        if ($('#getactualcount').is(':checked')) {
            qstring = qstring + '&get_actual_count=1';
        }
        if ($('#showsigmatparametervalues').is(':checked')) {
            qstring = qstring + '&showsigmatparametervalues=1';
        }
        if ($('#showstandardnameparametervalues').is(':checked')) {
            qstring = qstring + '&showstandardnameparametervalues=1';
        }
        if ($('#showallparametervalues').is(':checked')) {
            qstring = qstring + '&showallparametervalues=1';
        }
        if ($('#displayparameterplatformdata').is(':checked')) {
            qstring = qstring + '&displayparameterplatformdata=1';
        }
        if ( ! $('#showallparametervalues').is(':checked')) {
            //$('#parameter-value-table').html('<tbody></tbody>');
        }
        if (! init) {
            if (request.readyState < 3) {
                request.abort();
            }
        }
        var me = this;

        function onInit(data, key) {
            // Called from ajax on initial request
            initData = data;
            zoomedData = initData;
            if (key == 'platforms') {
                $.each(data[key], function (index, value) {
                    $('#platform-table > tbody:last').append('<tr id="' + value[1] +'"><td style="text-align:center;">' +
                            '<div id="' + value[1] + '_icon" align="center" style="float:left;width:20%;height:20px;background-color: rgb(192, 211, 228)">' +
                                '<div id="' + value[1] + '_color" style="border-bottom:2px solid;width:90%;height:9px;border-bottom-color:#' + 
                                    data['simpledepthtime']['colors'][value[1]] + ';">' +
                            '</div></div>' +
                            '<button class="btn btn-mini stoqs-toggle platform" style="float:left;width:80%;">'+ value[0] +'</button></td>' +
                        '</tr>');
                    $('#' + value[1] + '_icon').click( function () { $('#' + value[1] + ' > td > button').click() } );
                });
                $('.platform').tooltip({title: 'Click to select this Platform'});
            }
            else if (key == 'parameters') {
                var parameterButtonText = '';
                $.each(data[key], function (index, value) {
                    parameterButtonText = parameterButtonText + '<tr>' +
                            '<td id="' + value[0] +'">' +
                                '<button class="btn btn-mini stoqs-toggle parametername">'+ value[0] +'</button>' + 
                            '</td>';
                    if (value[1].length != 0) {
                        // Append '--' + value[0] + '-sn' to the id to distinguish them from parameter names that have the same standard_name
                        // A bit of a kludge, but should be robust as CF standard_names do not contain dashes
                        parameterButtonText = parameterButtonText +
                            '<td id="' + value[1] + '--' + value[0] + '-sn">' +
                                '<button class="btn btn-mini stoqs-toggle parameterstandardname">'+ value[1] +'</button>' + 
                            '</td>';
                    }
                    else {
                        parameterButtonText = parameterButtonText + '<td>&nbsp;</td>';
                    }
                    parameterButtonText = parameterButtonText + '</tr>';
                });
                $('#parameter-table > tbody:last').append(parameterButtonText);
                $('.parametername').tooltip({title: 'Click to select this Parameter name'});
                $('.parameterstandardname').tooltip({title: 'Click to select this Parameter standard_name'});
            }
            else if (key == 'time') { 
                var start = new Date(data[key][0]);
                $('#start-ems').val(start.getTime());
                $('#start-time').val(getUTCDateString(start));
                var end = new Date(data[key][1]);
                $('#end-ems').val(end.getTime());
                $('#end-time').val(getUTCDateString(end));
                //makeSlider('slider-' + key, key, data[key])
            }
            else if (key == 'depth') {
                $('#start-' + key).val(Math.round(data[key][0]*10)/10);
                $('#end-' + key ).val(Math.round(data[key][1]*10)/10);
                //makeSlider('slider-' + key, key, data[key])
            }
            else if (key == 'simpledepthtime') {
                //flotPlot(data)
                var start = new Date(data['time'][0]);
                var end = new Date(data['time'][1]);
                simpledepthtime_options_zoom = simpledepthtime_options;
                timedepthplot = $.plot($("#time-depth-flot"), getDataset(initData, start.getTime(), end.getTime()), 
                                                              simpledepthtime_options_zoom);

            }
            else if (key == 'activitymaptrackextent') {
                e = data[key];
                //console.log('00=' + e[0][0] + ' 01=' + e[0][1] + ' 10=' + e[1][0] + ' 11=' + e[1][1]);
                map.zoomToExtent(new OpenLayers.Bounds(e[0][0],e[0][1],e[1][0],e[1][1]));
            }
            else if (key == 'activityparameterhistograms') {
                // Create the html placeholders for the plots
                var histHtml = '<tbody>';
                $.each(data[key]['histdata'], function (parameter, histbyplatformandactivity) {
                    histHtml += '<tr>' +
                        '<td>' +
                            '<div id="' + parameter + '-histogram-flot" style="width:100%;height:100px;"></div>' +
                            '<p align="center">' + parameter + '</p>' +
                        '</td>' +
                        '</tr>';
                });
                histHtml += '</tbody>';
                $('#parameter-value-table').html(histHtml);
                // Bind for parameter value range selection - will trigger rebuildFilters() upon selection event, where onUpdate() will handle
                $.each(data[key]['histdata'], function (parameter, histbyplatformandactivity) {
                    histdata = [];
                    $("#" + parameter + "-histogram-flot").bind("plotselected", function (event, ranges) {
                        parametervalues[parameter] = {'xmin': ranges.xaxis.from, 'xmax': ranges.xaxis.to, 'ymin':0, 'ymax': ranges.yaxis.to };
                        rebuildFilters();
                    });
                });
                // Plot the histograms and any selected ranges that have been saved in the session
                $.each(data[key]['histdata'], function (parameter, histbyplatformandactivity) {
                    histdata = [];
                    $.each(histbyplatformandactivity, function (platform, histbyplatform) {
                        $.each(histbyplatform, function(activity, histbyactivity) {
                            histdata = collectHistData(histdata, platform, data[key]['rgbacolors'][platform], activity, histbyactivity);
                        });
                    });
                    plotHistData(parameter, histdata);
                });
            }
        } // onInit()

        function onUpdate(data, key) {
            // Called from ajax to update the selectors base on the new selection
            if (key == 'platforms') {
                zoomedData = data;
                var ids=[];
                $.each(data[key], function (index, value) {
                    // Here we need to enable those that are still valid.
                    var element=$('#' + value[1]);
                    enableButton($('button', element)); // Enable the button in the table row
                    ids.push(value[1]);
                });
                $('#platform-table > tbody > tr').each(function (index, elem) { 
                    if ($.inArray((elem.id).toString(), ids) == -1) {
                        disableButton($('button', $(elem))); // Disable the button in the table row
                    }
                });
            }
            else if (key == 'parameters') {
                zoomedData = data;
                var ids=[];
                $.each(data[key], function (index, value) {
                    // Here we need to enable those that are still valid
                    enableButton($('button', '#' + value[0]));              // Enable the name button in the table row
                    ids.push(value[0]);
                    if (value[1].length != 0) {
                        enableButton($('button', '#' + value[1] + '--' + value[0] + '-sn'));  // Enable the standard_name button in the table row
                        ids.push(value[1] + '--' + value[0] + '-sn');
                    }
                });
                $('#parameter-table > tbody > tr > td').each(function (index, elem) { 
                    if (elem.id.length != 0) {
                        if ($.inArray((elem.id).toString(), ids) == -1) {
                           disableButton($('button', $(elem))); // disable the button in the table row
                        }
                    }
                });
            }
            else if (key == 'simpledepthtime') {
                // Redraw the plot given the saved values
                theData = getDataset(zoomedData, $('#start-ems').val(), $('#end-ems').val());
                if ( ! theData ) {
                    return;
                }
                timedepthplot = $.plot($("#time-depth-flot"), theData, simpledepthtime_options_zoom);

                // Make the contour plot if checkbox is checked and is not disabled
                if ($('#displayparameterplatformdata').is(':checked') && ! $('#displayparameterplatformdata').parent().hasClass('disabled')) {
                    if (data['parameterplatformdatavaluepng'][0]) {
                        var flotdata = [ [ ["{{MEDIA_URL}}sections/" + data['parameterplatformdatavaluepng'][0], 
                                            $('#start-ems').val(), $('#start-depth').val(), $('#end-ems').val(), $('#end-depth').val()] ] ];
                        var options = $.extend(true, {}, simpledepthtime_options_zoom, {
                            series: { images: { show: true } },
                        });

                        $.plot.image.loadDataImages(flotdata, options, function () {
                            $.plot($("#time-depth-flot"), flotdata, options);
                        });
                        // Show colorbar
                        $('#sectioncolorbar').html('<img src="{{MEDIA_URL}}sections/' + data['parameterplatformdatavaluepng'][1] + '" />');
                    }
                    else {
                        alert(data['parameterplatformdatavaluepng'][2] + "  Try a different selection.");
                    }
                }
                else {
                    $('#sectioncolorbar').html('');
                }

            }
            else if (key == 'activitymaptrackextent') {
                e = data[key];
                if ($('#zoomtoextentonupdate').is(':checked')) {
                    map.zoomToExtent(new OpenLayers.Bounds(e[0][0],e[0][1],e[1][0],e[1][1]));
                }
            }
            else if (key == 'activityparameterhistograms') {
                var histHtml = '<tbody>';
                $.each(data[key]['histdata'], function (parameter, histbyplatformandactivity) {
                    histHtml += '<tr>' +
                        '<td>' +
                            '<div id="' + parameter + '-histogram-flot" style="width:100%;height:100px;"></div>' +
                            '<p align="center">' + parameter + '</p>' +
                        '</td>' +
                        '</tr>';
                });
                histHtml += '</tbody>';
                $('#parameter-value-table').html(histHtml);

                $.each(data[key]['histdata'], function (parameter, histbyplatformandactivity) {
                    histdata = [];
                    $("#" + parameter + "-histogram-flot").bind("plotselected", function (event, ranges) {
                        parametervalues[parameter] = {'min': ranges.xaxis.from, 'max': ranges.xaxis.to };
                        rebuildFilters();
                        histdata.push(addSelectedParameterValue(histdata, parameter));
                        console.log(parameter);
                        console.log(histdata);
                    });
                    $.each(histbyplatformandactivity, function (platform, histbyplatform) {
                        $.each(histbyplatform, function(activity, histbyactivity) {
                            histdata = collectHistData(histdata, platform, data[key]['rgbacolors'][platform], activity, histbyactivity);
                        });
                    });
                    plotHistData(parameter, histdata);
                });
            }
        } // onUpdate()

        request = $.ajax({
            type : 'GET',
            beforeSend: function() {
                $('#query-stats').html('<img src="{{STATIC_URL}}images/ajax-loader.gif">')
            },
            url : stoqsQuery + '?' + qstring,
            success: function (data) {
                setDataAccess(data)
                for (var key in data) {
                    if (init == true) {
                        onInit(data, key)
                    } else {
                        onUpdate(data, key)
                    }
                }
                // Refreshing map after processing the JSON response ensures that mapserver is ready to deliver the layers
                me.refreshMap();
                if ( ! $('#getactualcount').is(':checked')) {
                    $('#query-stats').html("<h4>Approximately " + data['count'] + " measured parameter data values from " + data['ap_count'] + " ActivityParameters</h4>");
                }
                else {
                    $('#query-stats').html("<h4>" + data['count'] + " measured parameter data values from " + data['ap_count'] + " ActivityParameters</h4>");
                }
            },
            dataType: "json"
        });
    } // updateSummaryData()
    
    
    $(function () { 
        // Initialize the accordian fields.
        $(".collapse").collapse(); // Collapse the accordian fields.
        
        // Adjust the height of the map div to 500px
        $('#map').height(500);
        
        // Add this behavior to all text fields, so when someone clicks on a field it highlights 
        // all the data so it's easy to copy to the clipboard.
        $(document).on('focus', 'input[type=text]', function(e) {
            // Select field contents
            var t=this
            // This has to be done after 100ms so that standard bootstrap functionality happens first.
            setTimeout(function() { t.select()}, 100);
        });

                
        /* 
         * Setup OpenLayers with some default background layers.
         */
        OpenLayers.IMAGE_RELOAD_ATTEMPTS = 4;
        OpenLayers.Util.onImageLoadError = function() {this.style.display="none"; };
        //ctrlGraticule = new OpenLayers.Control.Graticule({autoActivate : false});
        var options = {
            projection: new OpenLayers.Projection("EPSG:900913"),
            displayProjection: new OpenLayers.Projection("EPSG:4326"),
            units: "m",
            maxResolution: 156543.0339,
            maxExtent: new OpenLayers.Bounds(-20037508.34, -20037508.34,
                                              20037508.34, 20037508.34)
            //controls: [ctrlGraticule]
        };
        map = new OpenLayers.Map('map',options);

        var bathyEsri = new OpenLayers.Layer.XYZ(
            'ESRI Ocean'
            ,'http://services.arcgisonline.com/ArcGIS/rest/services/Ocean_Basemap/MapServer/tile/${z}/${y}/${x}.jpg'
            ,{
               sphericalMercator : true
              ,isBaseLayer       : true
              ,wrapDateLine      : true
              ,opacity           : 1
              ,visibility        : true
             }
        );

        var gebco_noaa = new OpenLayers.Layer.XYZ(
            "GEBCO & NOAA Tiles",
            [
                "http://{{ mapserver_host }}/gebco_noaa/tiles/${z}/${x}/${y}.png"
            ], 
            {
                attribution: "Sources: General Bathymetric Chart of the Oceans "
                + "(<a href='http://www.gebco.net/'>GEBCO</a>)"
                + " &amp; NOAA National Geophysical Data Center"
                + " (<a href='http://www.ngdc.noaa.gov/mgg/dem/demportal.html'>NGDC</a>)",
                sphericalMercator: true,
                wrapDateLine: true,
                transitionEffect: "resize",
                buffer: 1,
                numZoomLevels: 16
            }
        );
        var osm=new OpenLayers.Layer.OSM("OpenStreetMap");
        map.addLayers([bathyEsri,gebco_noaa,osm]);
        //ctrlGraticule.activate();

        /*
         * Maptrack layers selected by UI 
         */
        track_lines = new OpenLayers.Layer.WMS(
            "track_lines",
            "http://{{ mapserver_host }}/cgi-bin/mapserv",
            { layers: 'track_lines',
              map: '{{ mappath }}',
              transparent: 'True' },
            { units: 'degrees',
              displayInLayerSwitcher: true,
              projection: "EPSG:900913",
              reproject: false,
              visibility: true,
              singleTile: true, ratio: 1,
              displayOutsideMaxExtent: true } );
        map.addLayer(track_lines); 

        sample_points = new OpenLayers.Layer.WMS(
            "sample_points",
            "http://{{ mapserver_host }}/cgi-bin/mapserv",
            { layers: 'sample_points',
              map: '{{ mappath }}',
              transparent: 'True' },
            { units: 'degrees',
              displayInLayerSwitcher: true,
              projection: "EPSG:900913",
              reproject: false,
              visibility: true,
              singleTile: true, ratio: 1,
              displayOutsideMaxExtent: true } );
        map.addLayer(sample_points); 

        map.addControl(new OpenLayers.Control.LayerSwitcher());
        map.addControl(new OpenLayers.Control.MousePosition());
        map.addControl(new OpenLayers.Control.PanZoom());


        // Add polygon drawing tool and capture WKT of polygon as WGS84
        map.addLayer(polyLayer);
        var panelControls = [
            new OpenLayers.Control.Navigation(),
            new OpenLayers.Control.DrawFeature(polyLayer,
                OpenLayers.Handler.Polygon,
                {   'displayClass': 'olControlDrawFeaturePolygon',
                    featureAdded: function() {
                        var projWGS84 = new OpenLayers.Projection("EPSG:4326");
                        var proj900913 = new OpenLayers.Projection("EPSG:900913");
                        var polyWGS84 = polyLayer.features[0].geometry;
                        polyWGS84.transform(proj900913, projWGS84);
                        console.log(polyWGS84);
                        OpenLayers.Console.userError(polyWGS84);
                        rebuildFilters();
                    }
                }
            )
        ];
        var toolbar = new OpenLayers.Control.Panel({
            displayClass: 'olControlEditingToolbar',
            defaultControl: panelControls[0]
        });
        // Commented out until it's fully implemented
        //toolbar.addControls(panelControls);
        //map.addControl(toolbar);


        // Capture Feature info - both methods work with the data template specified as a file
        // - Put feature info into a <div>
        //map.events.register('click', map, function (e) {
        //    OpenLayers.Util.getElement('samplePoint').innerHTML = "Loading... please wait...";
        //    sample_point_url = sample_points.getFullRequestString({
        //                            REQUEST: "GetFeatureInfo",
        //                            EXCEPTIONS: "application/vnd.ogc.se_xml",
        //                            BBOX: sample_points.map.getExtent().toBBOX(),
        //                            X: e.xy.x,
        //                            Y: e.xy.y,
        //                            FEATURE_COUNT: 1,
        //                            INFO_FORMAT: 'text/html',
        //                            QUERY_LAYERS: sample_points.params.LAYERS,
        //                            WIDTH: sample_points.map.size.w,
        //                            HEIGHT: sample_points.map.size.h});
        //    
        //    OpenLayers.loadURL(sample_point_url, '', this, setHTML);
        //    OpenLayers.Event.stop(e);
        //});
        //function setHTML(response) {
        //    OpenLayers.Util.getElement('samplePoint').innerHTML = response.responseText;
        //}
        // - Create a popup window
        //var sample_points_info = new OpenLayers.Control.WMSGetFeatureInfo({
        //        url: "http://{{ mapserver_host }}/cgi-bin/mapserv",
        //        maxFeatures: 3,
        //        title: 'Identify features by clicking',
        //        queryVisible: true,
        //        layers: [sample_points],
        //        vendorParams: {
        //                 map: "{{ mappath }}",
        //        },
        //        eventListeners: {
        //            getfeatureinfo: function(event) {
        //                console.log(event);
        //                map.addPopup(new OpenLayers.Popup.FramedCloud(
        //                    "chicken",
        //                    map.getLonLatFromPixel(event.xy),
        //                    null,
        //                    event.text,
        //                    null,
        //                    true
        //                )); //map.addPopup
        //            } // getfeatureinfo
        //        } // eventListeners
        //    });
        //map.addControl(sample_points_info);
        //sample_points_info.activate();
        //End Capture Feature info tests


        /*
         *
         */
        updateSummaryData(true);

          
        $('body').on('change', '.slider-values', function (e) {
            var $slider=$('#slider-' + this.id.split('-').reverse()[0])
            var setting=$slider.data().reverseformatter($(this).val());
            var pos=0;
            if (this.id.split('-')[0] == 'start') {
                pos=0
            } else {
                pos=1
            }
            var oldvalue=$slider.slider('values',pos);
            var result=$slider.slider('values',pos,[setting]);
            if (Math.abs(setting-result) > 1) {
                jAlert('The data entered was not within the specified range, or exceeds the valid precision for this field. ' +
                        'the field has been reset to its original value.')
                $slider.slider("values",pos,[oldvalue])
            }
        });
        

        // Pan & zoom control - do we really need this?
        // show pan/zoom messages to illustrate events, see: http://people.iola.dk/olau/flot/examples/navigate.html
        $("#time-depth-flot").bind('plotpan', function (event, plot) {
            var axes = timedepthplot.getAxes();
            console.log("Panning to x: "  + axes.xaxis.min.toFixed(2)
                               + " - " + axes.xaxis.max.toFixed(2)
                               + " and y: " + axes.yaxis.min.toFixed(2)
                               + " - " + axes.yaxis.max.toFixed(2));
        });

        $("#time-depth-flot").bind('plotzoom', function (event, plot) {
            var axes = timedepthplot.getAxes();
            console.log("Zooming to x: "  + axes.xaxis.min.toFixed(2)
                               + " - " + axes.xaxis.max.toFixed(2)
                               + " and y: " + axes.yaxis.min.toFixed(2)
                               + " - " + axes.yaxis.max.toFixed(2));
        });

    
        // add zoom out button 
        $('<div class="button" style="right:20px;top:20px">zoom out</div>').appendTo($("#zoomnavigation")).click(function (e) {
            e.preventDefault();
            timedepthplot.zoomOut();
        });

        // and add panning buttons
        
        // little helper for taking the repetitive work out of placing
        // panning arrows
        function addArrow(dir, right, top, offset) {
            $('<img class="button" src="{{STATIC_URL}}images/arrow-' + dir + '.gif" style="right:' + right + 'px;top:' + top + 'px">').appendTo($("#zoomnavigation")).click(function (e) {
                e.preventDefault();
                timedepthplot.pan(offset);
            });
        }
    
        addArrow('left', 55, 60, { left: -10 });
        addArrow('right', 25, 60, { left: 10 });
        addArrow('up', 40, 45, { top: 10 });
        addArrow('down', 40, 75, { top: -10 });
        // Pan & zoom control - do we really need this?


        // Tooltips    
        $('#time-depth-anchor').click();
        $('#map-anchor').click();
        $('#parameters-anchor').tooltip({title: 'Click to toggle Parameters list'});
        $('#parameter-values-anchor').tooltip({title: 'Click to see histograms of parameter values and to select Measurement Data by parameter value range'});
        $('#platforms-anchor').tooltip({title: 'Click to toggle Platforms list'});
        $('#data-access-anchor').tooltip({title: 'Click to toggle data access options'});
        $('#getactualcount').tooltip({title: 'Will increase query time'});
        $('#displayparameterplatformdata').parent().tooltip({title: 'Select a Parameter name and a Platform to enable'});

    });

    </script>
  </body>
</html>
