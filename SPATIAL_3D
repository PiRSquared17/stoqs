SPATIAL_3D
==========

Creating terrain files for 3D spatial data visualization in STOQS
-----------------------------------------------------------------

GeoElevationGrid:
----------------

1. Execute script in mapping@elvis:/mbari/TerrainData/scripts to create .wrl or .x3dv file
2. Edit resulting file keeping heights and making it X3D:

<scene>
<shape>
    <Appearance>
        <Material diffuseColor='0.7 0.7 0.7'/>
    </Appearance>
    <GeoElevationGrid colorPerVertex='true' creaseAngle='3.14' geoGridOrigin='36 -122 0' geoSystem='"GD" "WE"' solid='false' xDimension='1438' xSpacing='0.0005057477' yScale='10' zDimension='1224' zSpacing='0.0005058092' normalPerVertex='true' ccw='true' containerField='geometry' height='-2403.4 ....'>
    </GeoElevationGrid>
</shape>
</scene>


POPGeometry from a GMT .grd file:
---------------------------------

0. Start with a GMT .grd file such as that produced by an mbgrid(1) execution
1. Convert to an xyz "point cloud", apply 10x vertical exaggeration, convert to Earth Centered Earth Fixed coordinate system, e.g.:

    grd2xyz MontBay100.grd --D_FORMAT=%f | sed '/NaN/d' | awk '{print $1, $2, 10 * $3}' | mapproject -E > MontBay100_10x.asc

2. Use Meshlab to construct a surface from the .asc file and save it as a .x3d IndexedFaceSet.  You need to use Meshlab interactively
   to load the .asc mesh, construct Normals and a surface, and clean it up before saving as a .ply or .x3d file.  Here are the
   suggested steps relevent to Meshlab_64bit v1.3.3 on a Mac:

    File -> Import Mesh                                         (Select .asc file produced in step 1 using defaults on the dialog)
    Filters -> Point Set -> Compute normals for point set       (Use defaults on dialog)
    Filters -> Point Set -> Surface Reconstruction Poisson      (Set Octree Depth to 11 and Solver Divide to 10)
    Wait a serveral minutes (There is no progress bar displayed)
    Filters -> Sampling -> Mesh Element Subsampling             (Set number of vertices to a number less than 1 million)
    Select the Sampled Mesh layer
    Filters -> Point Set -> Surface Reconstruction Poisson      (Set Octree Depth to 11 and Solver Divide to 10)
    Clean the new mesh by selecting face outside of the original point cloud and deleting them. (The Poisson reconstruction
    expects to create a closed surface and the extrapolated faces need to be removed.)
    File -> Export Mesh As                                      (Pick an appropriate .plyx name and have only Face Normal selected in the dialog)

3. Use InstantReality aopt tool to "flatten" the Scene and create POPGeometry, e.g.:

    mkdir /Users/mccann/Downloads/binGeo
    ./aopt -i /Users/mccann/Downloads/Monterey25_10x-clean.ply -F Scene -b /Users/mccann/Downloads/Monterey25_10x-opt.x3db
    ./aopt -i /Users/mccann/Downloads/Monterey25_10x-opt.x3db -f PrimitiveSet:creaseAngle:4 -V -K "/Users/mccann/Downloads/binGeo/:i" -N /Users/mccann/Downloads/Monterey25_10x.html

4. Copy the X3D <scene> element and its contents from the generated .html file into a .x3d file and put it along with the the associated files 
   in binGeo to the stoqs/static/x3d directory.  Replace the paths to the binGeo files with what works on the stoqs server, e.g.:

    :%s#/Users/mccann/Downloads#/stoqs/static/x3d#g

5. Test that the STOQS UI displays the new mesh in the Spatial -> 3D tab.


--
Mike McCann
MBARI 17 March 2014

